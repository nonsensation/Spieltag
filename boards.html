<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Scoreboards</title>
    <!-- Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Quantico:ital,wght@0,400;0,700;1,400;1,700&family=Press+Start+2P&family=Roboto:wght@300;400;500;700;900&family=Oswald:wght@400;700&family=Montserrat:wght@400;700;900&family=Teko:wght@500;700&display=swap" rel="stylesheet">
    
    <style>
        /* --- BASE VARIABLES & RESET --- */
        :root {
            /* User Colors */
            --home-primary: rgb(0, 0, 0);
            --home-secondary: rgb(30, 113, 58);
            --home-text: white;
            
            --guest-primary: red;
            --guest-secondary: white;
            --guest-text: black;

            /* Common Sizes */
            --base-size: min(2.5vw, 2.5vh);
        }

        body {
            font-size: 100%;
            margin: 0;
            padding: 0;
            background-color: transparent;
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100vh;
            overflow: hidden;
            font-family: 'Roboto', sans-serif;
        }

        /* Initial loader or fallback */
        .loading { font-family: monospace; color: #888; }
    </style>
</head>
<body>

<div id="board-container">
    <div class="loading">Loading design...</div>
</div>

<script type="text/javascript">
    // --- 1. Configuration & Parsing URL Parameters ---
    const urlParams = new URLSearchParams(window.location.search);
    const gameId = urlParams.get('id') || '42941';

    // Helper to get param or null
    const getParam = (key) => urlParams.get(key) ? decodeURIComponent(urlParams.get(key)) : null;

    // Design Param
    const design = getParam('design') || 'default';
    document.body.setAttribute('data-design', design);

    // Configuration Object
    const config = {
        home: {
            primary: getParam('hp'),   
            secondary: getParam('hs'), 
            text: getParam('ht'),      
            name: getParam('hn'),      
        },
        guest: {
            primary: getParam('gp'),
            secondary: getParam('gs'),
            text: getParam('gt'),
            name: getParam('gn'),
        }
    };

    // --- 2. Helpers ---
    // Apply Visual Overrides immediately (Colors)
    const root = document.documentElement;
    if (config.home.primary) root.style.setProperty('--home-primary', config.home.primary);
    if (config.home.secondary) root.style.setProperty('--home-secondary', config.home.secondary);
    if (config.home.text) root.style.setProperty('--home-text', config.home.text);
    
    if (config.guest.primary) root.style.setProperty('--guest-primary', config.guest.primary);
    if (config.guest.secondary) root.style.setProperty('--guest-secondary', config.guest.secondary);
    if (config.guest.text) root.style.setProperty('--guest-text', config.guest.text);

    // Helper: Safe Text Update
    const setTextIfChanged = (id, text) => {
        const el = document.getElementById(id);
        if (el && el.innerText !== text) el.innerText = text;
    };

    function fixLogoUrl(url) {
        if (!url) return '';
        if (url.startsWith('/')) {
            return 'https://saisonmanager.de' + url;
        }
        return url;
    }

    // --- 3. Logic ---
    async function loadDesign() {
        const container = document.getElementById('board-container');
        
        // 1. Load HTML Content
        if (design === 'custom') {
            const customCode = localStorage.getItem('scoreboardCustomCode');
            if (customCode) {
                container.innerHTML = customCode;
            } else {
                container.innerHTML = '<div style="color:red">No custom code found.</div>';
            }
        } else {
            try {
                const response = await fetch(`designs/${design}.html`);
                if (!response.ok) throw new Error(`Design ${design} not found`);
                const html = await response.text();
                container.innerHTML = html;
            } catch (err) {
                console.error(err);
                container.innerHTML = `<div style="color:red">Error loading design: ${design}</div>`;
            }
        }

        // 2. Execute Scripts (if any)
        const scripts = container.getElementsByTagName("script");
        for(let i=0; i<scripts.length; i++) {
            try { eval(scripts[i].innerText); } catch(e) { console.error('Script error:', e); }
        }

        // 3. Apply Name Overrides (Now that DOM exists)
        if (config.home.name) setTextIfChanged('name_home', config.home.name);
        if (config.guest.name) setTextIfChanged('name_away', config.guest.name);

        // 4. Trigger Data Fetch
        fetchGameData();
    }

    // --- 3. API Fetching Logic ---
    const API_URL = `https://saisonmanager.de/api/v2/games/${gameId}.json`;
    
    // Interval from URL (in seconds), default 10s
    const paramInterval = parseFloat(getParam('interval'));
    const FETCH_INTERVAL = (paramInterval && paramInterval > 0) ? (paramInterval * 1000) : 10000;

    async function fetchGameData() {
        try {
            const response = await fetch(API_URL);
            if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
            const data = await response.json();
            const res = data.result;

            // Update Scores & Period
            const hGoals = (res?.home_goals ?? 0).toString();
            const gGoals = (res?.guest_goals ?? 0).toString();
            const period = (data.current_period_title?.title ?? "1. Drittel");

            setTextIfChanged('score_home', hGoals);
            setTextIfChanged('score_away', gGoals);
            setTextIfChanged('period', period);

            // Update Names (Only if NOT overridden via URL)
            if (!config.home.name && data.home_team_name) {
                setTextIfChanged('name_home', data.home_team_name);
            }
            if (!config.guest.name && data.guest_team_name) {
                setTextIfChanged('name_away', data.guest_team_name);
            }

            // Update Logos
            const updateLogo = (imgId, rawUrl) => {
                const img = document.getElementById(imgId);
                // Safety check: image element must exist
                if (!img) return;
                
                if (!rawUrl) {
                    img.style.display = 'none';
                    return;
                }
                
                const fullUrl = fixLogoUrl(rawUrl);
                
                if (img.dataset.src !== fullUrl) {
                    img.src = fullUrl;
                    img.dataset.src = fullUrl; 
                    img.style.display = 'block';
                }
            };

            updateLogo('img_home', data.home_team_logo);
            updateLogo('img_away', data.guest_team_logo);

        } catch (error) {
            console.error('Error fetching scoreboard data:', error);
        }
    }

</script>

<!-- Penalty Overlay Containers -->
<div id="penalties-home" class="penalty-overlay home-side"></div>
<div id="penalties-guest" class="penalty-overlay guest-side"></div>

<style>
    .penalty-overlay {
        position: absolute;
        bottom: 5%; /* Position at bottom or adjust as needed */
        display: flex;
        flex-direction: column;
        gap: 5px;
        z-index: 100;
        font-family: 'Quantico', sans-serif; /* Match scoreboard font */
        font-weight: bold;
        font-size: min(1.8vw, 1.8vh);
        pointer-events: none; /* Let clicks pass through */
    }
    .home-side {
        left: 2%; /* Anchor to left */
        align-items: flex-start;
        color: var(--home-text, white);
        text-shadow: 1px 1px 2px rgba(0,0,0,0.8);
    }
    .guest-side {
        right: 2%; /* Anchor to right */
        align-items: flex-end;
        color: var(--guest-text, white);
        text-shadow: 1px 1px 2px rgba(0,0,0,0.8);
    }
    
    .penalty-item {
        background: rgba(0, 0, 0, 0.6);
        padding: 0.2em 0.5em;
        border-radius: 4px;
        display: flex;
        gap: 0.5em;
        border: 1px solid rgba(255,255,255,0.2);
    }
    .pen-time { color: #ff3b30; }
</style>

<script>
    // --- 4. Timer Logic (BroadcastChannel) ---
    const timerChannel = new BroadcastChannel('scoreboard_timer');
    
    timerChannel.onmessage = (event) => {
        if (event.data.type === 'timer_update') {
            updateTimerDisplay(event.data);
            if (event.data.penalties) {
                renderPenalties(event.data.penalties);
            }
        }
    };

    function updateTimerDisplay(data) {
        // Find time element (class "time" is standard in our designs)
        // We look inside board-container
        const timeEl = document.querySelector('.time');
        
        if (timeEl) {
            if (data.visible) {
                timeEl.style.display = 'block'; 
                
                // If the design has specific display preferences, we might need a class toggle instead.
                if (getComputedStyle(timeEl).display === 'none') {
                    timeEl.style.display = 'block';
                }
                
                timeEl.style.color = 'inherit'; // Reset transparency if any
                if (timeEl.style.color === 'transparent') {
                     timeEl.style.color = 'white'; // or inherit
                }
                
                // Update text
                timeEl.innerText = data.timeString;
            } else {
                timeEl.style.display = 'none';
            }
        }
    }

    function renderPenalties(penalties) {
        const hContainer = document.getElementById('penalties-home');
        const gContainer = document.getElementById('penalties-guest');
        
        // Colors might be needed? We use CSS vars inherited from root or set in style
        // Actually CSS vars --home-text etc are set on :root in boards.html so they are available
        
        hContainer.innerHTML = '';
        gContainer.innerHTML = '';
        
        penalties.forEach(p => {
            const el = document.createElement('div');
            el.className = 'penalty-item';
            el.innerHTML = `
                <span>#${p.number}</span>
                <span class="pen-time">${p.remaining > 0 ? formatTime(p.remaining) : '0:00'}</span>
            `;
            
            if (p.team === 'home') hContainer.appendChild(el);
            else gContainer.appendChild(el);
        });
    }

    function formatTime(totalSeconds) {
        const s = Math.abs(totalSeconds);
        const m = Math.floor(s / 60);
        const sec = s % 60;
        return `${m}:${sec.toString().padStart(2, '0')}`;
    }

    // Start
    loadDesign();
    setInterval(fetchGameData, FETCH_INTERVAL);

</script>
</body>
</html>
