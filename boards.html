<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Scoreboards</title>
    <!-- Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Quantico:ital,wght@0,400;0,700;1,400;1,700&family=Press+Start+2P&family=Roboto:wght@300;400;500;700;900&family=Oswald:wght@400;700&family=Montserrat:wght@400;700;900&family=Teko:wght@500;700&display=swap" rel="stylesheet">
    
    <style>
        /* --- BASE VARIABLES & RESET --- */
        :root {
            /* User Colors */
            --home-primary: rgb(0, 0, 0);
            --home-secondary: rgb(30, 113, 58);
            --home-text: white;
            
            --guest-primary: red;
            --guest-secondary: white;
            --guest-text: black;

            /* Common Sizes */
            --base-size: min(2.5vw, 2.5vh);
        }

        body {
            font-size: 100%;
            margin: 0;
            padding: 0;
            background-color: transparent;
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100vh;
            overflow: hidden;
            font-family: 'Roboto', sans-serif;
        }

        /* Initial loader or fallback */
        .loading { font-family: monospace; color: #888; }
    </style>
</head>
<body>

<div id="board-container">
    <div class="loading">Loading design...</div>
</div>

<script type="text/javascript">
    // --- 1. Configuration & Parsing URL Parameters ---
    const urlParams = new URLSearchParams(window.location.search);
    const gameId = urlParams.get('id') || '42941';

    // Helper to get param or null
    const getParam = (key) => urlParams.get(key) ? decodeURIComponent(urlParams.get(key)) : null;

    // Design Param
    const design = getParam('design') || 'default';
    document.body.setAttribute('data-design', design);

    // Load Design: Custom, or Fetch from file
    async function loadDesign() {
        const container = document.getElementById('board-container');
        
        if (design === 'custom') {
            const customCode = localStorage.getItem('scoreboardCustomCode');
            if (customCode) {
                container.innerHTML = customCode;
            } else {
                container.innerHTML = '<div style="color:red">No custom code found.</div>';
            }
        } else {
            try {
                // Fetch the design HTML file
                const response = await fetch(`designs/${design}.html`);
                if (!response.ok) throw new Error(`Design ${design} not found`);
                const html = await response.text();
                container.innerHTML = html;
            } catch (err) {
                console.error(err);
                container.innerHTML = `<div style="color:red">Error loading design: ${design}</div>`;
            }
        }

        // Execute scripts if any (simple eval)
        const scripts = container.getElementsByTagName("script");
        for(let i=0; i<scripts.length; i++) {
            try { eval(scripts[i].innerText); } catch(e) { console.error('Script error:', e); }
        }

        // Trigger data update immediately after loading structure
        fetchGameData();
    }
    
    loadDesign();

    // Configuration Object
    const config = {
        home: {
            primary: getParam('hp'),   // Home Primary Color
            secondary: getParam('hs'), // Home Secondary Color
            text: getParam('ht'),      // Home Text Color
            name: getParam('hn'),      // Home Name Override
        },
        guest: {
            primary: getParam('gp'),
            secondary: getParam('gs'),
            text: getParam('gt'),
            name: getParam('gn'),
        }
    };

    // --- 2. Apply Visual Overrides immediately (Colors) ---
    const root = document.documentElement;
    if (config.home.primary) root.style.setProperty('--home-primary', config.home.primary);
    if (config.home.secondary) root.style.setProperty('--home-secondary', config.home.secondary);
    if (config.home.text) root.style.setProperty('--home-text', config.home.text);
    
    if (config.guest.primary) root.style.setProperty('--guest-primary', config.guest.primary);
    if (config.guest.secondary) root.style.setProperty('--guest-secondary', config.guest.secondary);
    if (config.guest.text) root.style.setProperty('--guest-text', config.guest.text);

    // Apply Name Overrides immediately if they exist (prevents flickering before API load)
    const setTextIfChanged = (id, text) => {
        const el = document.getElementById(id);
        if (el && el.innerText !== text) el.innerText = text;
    };

    if (config.home.name) setTextIfChanged('name_home', config.home.name);
    if (config.guest.name) setTextIfChanged('name_away', config.guest.name);


    // --- 3. API Fetching Logic ---
    const API_URL = `https://saisonmanager.de/api/v2/games/${gameId}.json`;
    const FETCH_INTERVAL = 10000;

    function fixLogoUrl(url) {
        if (!url) return '';
        if (url.startsWith('/')) {
            return 'https://saisonmanager.de' + url;
        }
        return url;
    }

    async function fetchGameData() {
        try {
            const response = await fetch(API_URL);
            if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
            const data = await response.json();
            const res = data.result;

            // Update Scores & Period safely
            const hGoals = (res?.home_goals ?? 0).toString();
            const gGoals = (res?.guest_goals ?? 0).toString();
            const period = (data.current_period_title?.title ?? "1. Drittel");

            setTextIfChanged('score_home', hGoals);
            setTextIfChanged('score_away', gGoals);
            setTextIfChanged('period', period);

            // Update Names (Only if NOT overridden via URL)
            // Use local vars first, apply safely
            if (!config.home.name && data.home_team_name) {
                setTextIfChanged('name_home', data.home_team_name);
            }
            if (!config.guest.name && data.guest_team_name) {
                setTextIfChanged('name_away', data.guest_team_name);
            }

            // Update Logos without Reloading if same
            const updateLogo = (imgId, rawUrl) => {
                if (!rawUrl) return;
                const fullUrl = fixLogoUrl(rawUrl);
                const img = document.getElementById(imgId);
                // Check against dataset to avoid "normalized" src mismatches or Blob reload issues
                if (img.dataset.src !== fullUrl) {
                    img.src = fullUrl;
                    img.dataset.src = fullUrl; // store the source of truth
                    img.style.display = 'block';
                }
            };

            updateLogo('img_home', data.home_team_logo);
            updateLogo('img_away', data.guest_team_logo);

        } catch (error) {
            console.error('Error fetching scoreboard data:', error);
        }
    }

    // Initial load and Interval
    // fetchGameData() is called in loadDesign() after the DOM is ready
    setInterval(fetchGameData, FETCH_INTERVAL);

</script>
</body>
</html>
