<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Scoreboard Generator</title>
    <!-- Add QR Code JS -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    <style>
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; padding: 20px; background: #f0f2f5; color: #333; margin: 0; height: 100vh; display: flex; flex-direction: column; overflow: hidden; }
        
        .container { 
            display: flex; 
            flex: 1; 
            width: 100%; 
            height: 100%; 
            max-width: 100%; 
            gap: 20px; 
            padding-bottom: 20px;
            box-sizing: border-box;
        }

        /* Preview Area: Takes up available space */
        .preview { 
            flex: 1; 
            background-color: #202020;
            background-image:
              linear-gradient(45deg, #2a2a2a 25%, transparent 25%),
              linear-gradient(-45deg, #2a2a2a 25%, transparent 25%),
              linear-gradient(45deg, transparent 75%, #2a2a2a 75%),
              linear-gradient(-45deg, transparent 75%, #2a2a2a 75%);
            background-size: 20px 20px;
            background-position: 0 0, 0 10px, 10px -10px, -10px 0px;
            box-shadow: inset 0 0 20px rgba(0,0,0,0.5);
            border-radius: 8px; 
            display: flex; 
            justify-content: center; 
            align-items: center; 
            flex-direction: column;
            position: relative;
            overflow: hidden;
            border: 1px solid #444;
        }

        .preview h2 {
            position: absolute;
            top: 10px;
            left: 20px;
            color: rgba(255,255,255,0.5);
            margin: 0;
            font-size: 1.2rem;
            z-index: 10;
        }

        /* Controls Sidebar: Fixed width or limited flex */
        .controls { 
            width: 320px; 
            min-width: 320px;
            background: white; 
            padding: 20px; 
            border-radius: 8px; 
            box-shadow: -2px 0 10px rgba(0,0,0,0.1); 
            overflow-y: auto;
            display: flex;
            flex-direction: column;
        }

        h3 { margin-top: 0; border-bottom: 2px solid #eee; padding-bottom: 10px; margin-bottom: 15px; }
        
        .form-group { margin-bottom: 12px; }
        label { display: block; margin-bottom: 4px; font-weight: 600; font-size: 0.85em; color: #555; }
        input[type="text"], input[type="number"], select { width: 100%; padding: 8px; border: 1px solid #ccc; border-radius: 4px; box-sizing: border-box; font-size: 0.9em; }
        
        .color-row { display: flex; gap: 8px; align-items: center; }
        input[type="color"] { border: none; width: 100%; height: 35px; cursor: pointer; background: none; padding: 0; }
        
        .section-title { font-size: 0.8em; text-transform: uppercase; letter-spacing: 1px; color: #888; margin-top: 15px; margin-bottom: 8px; font-weight: bold; border-bottom: 1px solid #eee; padding-bottom: 2px;}

        button { background: #007bff; color: white; border: none; padding: 10px; border-radius: 4px; cursor: pointer; font-size: 0.95em; width: 100%; margin-top: 5px; transition: background 0.2s; font-weight: 500;}
        button:hover { background: #0056b3; }
        button.secondary { background: #6c757d; }
        button.secondary:hover { background: #5a6268; }
        
        iframe { border: none; width: 100%; flex: 1; height: 0; min-height: 0; background: transparent; }
        
        .loader { font-size: 0.8em; color: #666; font-style: italic; display: none; margin-top: 5px;}
        
        .url-output { margin-top: auto; padding-top: 20px; border-top: 2px solid #eee; }
        .url-text { font-family: monospace; font-size: 0.8em; word-break: break-all; color: #555; background: #f8f9fa; padding: 5px; border-radius: 4px; border: 1px solid #ddd; margin-bottom: 10px; max-height: 60px; overflow-y: auto; }

        #qrcode {
            margin-top: 15px;
            display: flex;
            justify-content: center;
            background: white;
            padding: 10px;
            border-radius: 4px;
            border: 1px solid #eee;
            width: fit-content;
            margin-left: auto; 
            margin-right: auto; 
        }
        #qrcode img {
            display: block;
        }

        /* --- RESPONSIVE & UI IMPROVEMENTS --- */
        
        /* Mobile Breakpoint */
        @media (max-width: 900px) {
            .container { 
                flex-direction: column; /* Preview on top, controls below */
                height: auto; 
                overflow-y: auto;
            }
            body { 
                height: auto; 
                overflow-y: auto; 
            }
            .controls { 
                width: 100%; 
                min-width: 0; 
                box-shadow: none;
                border-top: 1px solid #ddd;
            }
            .preview { 
                min-height: 50vh; /* Takes half screen on mobile */
                border-radius: 0;
                border-left: none; border-right: none;
                border-top: none;
            }
        }

        /* Input Touch Improvements */
        input, select, button {
            min-height: 40px; /* Touch target size */
            font-size: 16px; /* Prevent zoom on iOS */
        }
        
        /* Timer Panel Revamp */
        .timer-panel {
            background: #111;
            width: 100%;
            padding: 15px;
            box-sizing: border-box;
            border-top: 1px solid #333;
            color: #eee;
            display: grid;
            gap: 15px;
            /* Default: Standard flex/grid layout */
            grid-template-columns: 1fr auto 1fr;
            align-items: center;
        }

        @media (max-width: 700px) {
            .timer-panel {
                grid-template-columns: 1fr;
                gap: 20px;
                text-align: center;
            }
        }

        /* Left: Time Display & Vis */
        .timer-section-left {
            display: flex;
            align-items: center;
            gap: 15px;
        }
        @media (max-width: 700px) { .timer-section-left { justify-content: center; } }

        .timer-display {
            font-family: 'Courier New', monospace;
            font-size: 2.5em;
            font-weight: bold;
            color: #ff3b30;
            background: #000;
            padding: 5px 15px;
            border-radius: 6px;
            border: 1px solid #333;
            line-height: 1;
            cursor: pointer; /* Click to edit? Maybe later */
        }

        .vis-toggle {
            cursor: pointer;
            opacity: 0.4;
            transition: all 0.2s;
            display: flex;
            flex-direction: column;
            align-items: center;
            font-size: 0.75em;
            color: #fff;
        }
        .vis-toggle:hover { opacity: 0.8; }
        .vis-toggle.active { opacity: 1; color: #4cd964; text-shadow: 0 0 10px rgba(76, 217, 100, 0.5); }
        .vis-toggle i { font-size: 1.8em; margin-bottom: 2px; font-style: normal; }

        /* Center: Main Controls */
        .timer-section-center {
            display: flex;
            justify-content: center;
            align-items: center;
        }

        .btn-main-control {
            width: 140px;
            height: 140px;
            border-radius: 50%;
            border: none;
            cursor: pointer;
            font-size: 6rem; /* Controls SVG size via em */
            padding: 0;
            margin: 10px;
            color: white; /* For currentColor fill */
            
            /* Flexbox Centering */
            display: flex;
            align-items: center;
            justify-content: center;
            
            transition: transform 0.1s, background 0.2s;
            box-shadow: 0 6px 20px rgba(0,0,0,0.4);
        }
        .btn-main-control svg {
            width: 1em;
            height: 1em;
            fill: currentColor;
            display: block;
        }
        .btn-main-control:active { transform: scale(0.95); }
        
        .btn-play { background: #34c759; color: white; }
        .btn-play:hover { background: #30b753; box-shadow: 0 0 20px rgba(52, 199, 89, 0.4); }
        
        .btn-stop { background: #ff3b30; color: white; }
        .btn-stop:hover { background: #e0362b; box-shadow: 0 0 20px rgba(255, 59, 48, 0.4); }

        /* Right: Adjustments */
        .timer-section-right {
            display: flex;
            flex-direction: column;
            gap: 8px;
            align-items: flex-end;
        }
        @media (max-width: 700px) { .timer-section-right { align-items: center; } }

        .timer-adjust-row {
            display: flex;
            gap: 5px;
        }

        .btn-adj {
            background: #333;
            border: 1px solid #444;
            color: #ddd;
            padding: 5px 10px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.85em;
            width: 45px;
            transition: background 0.2s;
        }
        .btn-adj:hover { background: #444; }

        .timer-settings-row {
            display: flex;
            gap: 10px;
            align-items: center;
        }
        
        .timer-select {
            background: #222;
            color: white;
            border: 1px solid #444;
            padding: 5px 10px;
            border-radius: 4px;
            font-size: 0.9em;
        }

        .btn-reset {
            background: transparent;
            border: 1px solid #555;
            color: #aaa;
            padding: 5px 10px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.8em;
        }
        .btn-reset:hover { border-color: #888; color: #fff; }

        /* Hide logic helpers */
        .hidden { display: none !important; }
    </style>
</head>
<body>

<div class="container">
    <!-- PREVIEW AREA -->
    <div class="preview">
        <h2>Live Vorschau</h2>
        <iframe id="previewFrame" src="boards.html?id=42941"></iframe>
        
        <!-- Penalties Overlay (Controller View) -->
        <div id="ctlPenaltiesHome" style="position:absolute; top:50px; left:20px; display:flex; flex-direction:column; gap:5px; z-index:20;"></div>
        <div id="ctlPenaltiesGuest" style="position:absolute; top:50px; right:20px; display:flex; flex-direction:column; gap:5px; z-index:20; align-items:flex-end;"></div>

        <!-- Timer Controls - Added as overlay/panel under preview -->
        <div class="timer-panel">
            
            <!-- LEFT: Display & Vis -->
            <div class="timer-section-left">
                <div id="visToggle" class="vis-toggle" onclick="toggleTimerVis()" title="Klicke zum Anzeigen auf dem Scoreboard">
                    <i>üëÅÔ∏è</i>
                    <span>LIVE</span>
                </div>
                <div class="timer-display" id="timerValue" onclick="toggleTimerVis()">20:00</div>
            </div>

            <!-- CENTER: Big Play Button -->
            <div class="timer-section-center">
                <button id="btnStart" class="btn-main-control btn-play" onclick="startTimer()" title="Start">
                    <svg viewBox="0 0 24 24"><path d="M8 5v14l11-7z"/></svg>
                </button>
                <button id="btnStop" class="btn-main-control btn-stop hidden" onclick="stopTimer()" title="Stop">
                    <svg viewBox="0 0 24 24"><path d="M6 19h4V5H6v14zm8-14v14h4V5h-4z"/></svg>
                </button>
            </div>

            <!-- RIGHT: Adjustments & Settings -->
            <div class="timer-section-right">
                <div class="timer-adjust-row">
                     <button class="btn-adj" onclick="adjustTime(-60)">-1m</button>
                     <button class="btn-adj" onclick="adjustTime(-10)">-10s</button>
                     <button class="btn-adj" onclick="adjustTime(10)">+10s</button>
                     <button class="btn-adj" onclick="adjustTime(60)">+1m</button>
                </div>
                
                <div class="timer-settings-row">
                    <button class="btn-reset" onclick="resetTimer()">RESET</button>
                    
                    <select id="timerPreset" class="timer-select" onchange="applyPreset()">
                        <option value="20">20 Min (Spiel)</option>
                        <option value="15">15 Min (Spiel)</option>
                        <option value="10">10 Min (Pause)</option>
                        <option value="custom">Custom</option>
                    </select>

                    <button id="btnAddPenalty" class="btn-reset" onclick="openPenaltyModal()" style="border-color: #ff3b30; color: #ff3b30;">+ STRAFE</button>

                    <div style="font-size:0.8em; color:#888; display: flex; gap: 5px;">
                        <label title="Abw√§rts"><input type="radio" name="tm_dir" value="-1" checked onchange="updateDirection()"> ‚ñº</label>
                        <label title="Aufw√§rts"><input type="radio" name="tm_dir" value="1" onchange="updateDirection()"> ‚ñ≤</label>
                    </div>

                </div>
                
                <div id="customTimeInput" style="display:none; align-items: center; gap: 5px; margin-top: 5px;">
                    <input type="number" id="customMin" value="20" style="width: 50px; padding: 5px; background: #333; color: white; border: 1px solid #555;" onchange="applyPreset()"> Min
                </div>
            </div>
        </div>
    </div>

    <!-- SIDEBAR CONTROLS -->
    <div class="controls">
        <h3>Konfiguration</h3>
        
        <div class="form-group">
            <label>Design Stil</label>
            <select id="designStyle" onchange="generate()">
                <option value="default">Standard (Original)</option>
                <option value="retro">Retro Pixel</option>
                <option value="modern">Modern Schlicht</option>
                <option value="neon">Neon</option>
                <option value="broadcast">TV √úbertragung</option>
                <option value="glass">Glassmorphism</option>
                <option value="bold">Fett Gedruckt</option>
                <option value="material">Material Karte</option>
                <option value="cyberpunk">Cyberpunk</option>
                <option value="islands">Schwebende Inseln</option>
                <option value="custom">Eigener Code</option>
            </select>
        </div>

        <div id="customCodeTrigger" style="display:none; margin-bottom: 20px;">
             <button type="button" onclick="openEditor()" style="background:#28a745; width:100%;">Code Editor √∂ffnen</button>
             <div style="font-size:0.8em; color:#666; margin-top:5px; font-style:italic;">Klicken zum Bearbeiten des eigenen Designs.</div>
        </div>

        <!-- Full Screen Editor Modal -->
        <div id="editorModal" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:white; z-index:2000; flex-direction:column;">
            <!-- Modal Header -->
            <div style="display:flex; justify-content:space-between; align-items:center; padding:10px 20px; background:#f8f9fa; border-bottom:1px solid #ddd;">
                <h3 style="margin:0; border:none; padding:0;">Editor f√ºr eigenes Design</h3>
                <div style="display:flex; gap:10px;">
                    <button type="button" class="secondary" onclick="resetCustomCode()" style="width:auto; padding:8px 15px; margin:0; background:#dc3545;">Zur√ºcksetzen</button>
                    <button type="button" onclick="closeEditor()" style="width:auto; padding:8px 15px; margin:0;">Speichern & Schlie√üen</button>
                </div>
            </div>
            
            <!-- Modal Body -->
            <div style="display:flex; flex:1; overflow:hidden;">
                <!-- Code Area -->
                <div style="flex:1; display:flex; flex-direction:column; padding:10px; border-right:1px solid #ddd;">
                    <label style="margin-bottom:5px;">HTML & CSS</label>
                    <textarea id="customCode" style="flex:1; width:100%; border:1px solid #ccc; font-family:monospace; font-size:14px; padding:10px; white-space:pre; resize:none; box-sizing:border-box;" placeholder="F√ºge hier deinen HTML Scoreboard Code ein..." oninput="generate(true)"></textarea>
                </div>
                
                <!-- Info Sidebar -->
                <div style="width:300px; padding:15px; overflow-y:auto; background:#fafafa;">
                    <h4 style="margin-top:0;">Verf√ºgbare Variablen</h4>
                    <p style="font-size:0.9em; color:#666;">Benutze diese IDs f√ºr die Datenbindung:</p>
                    <ul style="font-size:0.85em; padding-left:20px; color:#444;">
                        <li><code>period</code>: Aktueller Abschnitt</li>
                        <li><code>time</code>: Spielzeit (meist unsichtbar)</li>
                        <li><code>img_home</code>: Heim Logo (img src)</li>
                        <li><code>name_home</code>: Heim Name</li>
                        <li><code>score_home</code>: Heim Tore</li>
                        <li><code>img_away</code>: Gast Logo (img src)</li>
                        <li><code>name_away</code>: Gast Name</li>
                        <li><code>score_away</code>: Gast Tore</li>
                    </ul>

                    <h4 style="margin-top:15px;">CSS Variablen</h4>
                    <p style="font-size:0.9em; color:#666;">Benutze <code>var(--name)</code> f√ºr Farben:</p>
                    <ul style="font-size:0.85em; padding-left:20px; color:#444;">
                        <li><code>--home-primary</code></li>
                        <li><code>--home-secondary</code></li>
                        <li><code>--home-text</code></li>
                        <li><code>--guest-primary</code></li>
                        <li><code>--guest-secondary</code></li>
                        <li><code>--guest-text</code></li>
                    </ul>
                    
                    <div style="margin-top:20px; padding:10px; background:#e9ecef; border-radius:4px; font-size:0.85em;">
                        <strong>Tipp:</strong> Nutze einen Container mit der Klasse <code>scoreboard</code>.
                    </div>
                </div>
            </div>
        </div>
        
        <div class="form-group">
            <label>Spiel ID</label>
            <div style="display:flex; gap:5px;">
                <input type="number" id="gameId" value="42941" placeholder="z.B. 42941" oninput="fetchGameDetails()">
                <button type="button" onclick="fetchGameDetails()" style="width: auto; margin:0; padding: 0 15px;">Laden</button>
            </div>
            <div class="loader" id="loader">Lade Namen...</div>
        </div>

        <div class="form-group">
             <label>Update Intervall (Sekunden)</label>
             <input type="number" id="updateInterval" value="10" min="1" onchange="generate()">
        </div>

        <div class="form-group">
            <label>Strafen Tracking</label>
            <select id="penaltyMode" onchange="togglePenaltyMode()">
                <option value="manual">Manuell</option>
                <option value="none">Aus (Keine Anzeige)</option>
                <!-- option value="auto" disabled>Automatisch (Bald)</option -->
            </select>
        </div>

        <div class="section-title">Heimteam</div>
        <div class="form-group">
            <div style="display:flex; align-items: center; gap: 10px; margin-bottom: 5px;">
                <img id="homeLogoPreview" src="" alt="" style="display:none; height: 30px; object-fit: contain;">
                <input type="text" id="hn" placeholder="Name √ºberschreiben" oninput="generate()">
            </div>
            <div class="color-row">
                <input type="color" id="hp" value="#000000" title="Prim√§r" oninput="generate()">
                <input type="color" id="hs" value="#1e713a" title="Sekund√§r" oninput="generate()">
                <input type="color" id="ht" value="#ffffff" title="Text" oninput="generate()">
            </div>
        </div>

        <div class="section-title">Gastteam</div>
        <div class="form-group">
            <div style="display:flex; align-items: center; gap: 10px; margin-bottom: 5px;">
                <img id="guestLogoPreview" src="" alt="" style="display:none; height: 30px; object-fit: contain;">
                <input type="text" id="gn" placeholder="Name √ºberschreiben" oninput="generate()">
            </div>
            <div class="color-row">
                <input type="color" id="gp" value="#ff0000" title="Prim√§r" oninput="generate()">
                <input type="color" id="gs" value="#ffffff" title="Sekund√§r" oninput="generate()">
                <input type="color" id="gt" value="#000000" title="Text" oninput="generate()">
            </div>
        </div>

        <div class="url-output" id="urlOutput" style="display:none;">
            <label>Generierte URL:</label>
            <div class="url-text" id="finalUrl"></div>
            <button id="copyBtn" onclick="copyAndOpen()">Kopieren & √ñffnen</button>
            
            <div id="qrcode"></div>
        </div>
        
        <footer style="margin-top: 30px; padding-top: 15px; border-top: 1px solid #eee; text-align: center;">
            <a href="#" onclick="openAboutModal()" style="color: #666; text-decoration: none; font-size: 0.85em;">√úber & Datenschutz</a>
        </footer>
    </div>
</div>

    </div>
</div>

<!-- Penalty Modal -->
<div id="penaltyModal" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.8); z-index:2000; justify-content:center; align-items:center;">
    <div style="background:white; padding:20px; border-radius:8px; width:90%; max-width:500px; display:flex; flex-direction:column; gap:15px; max-height:90vh;">
        <h3 style="margin:0; text-align:center;">Strafe hinzuf√ºgen</h3>
        
        <!-- Team Selection -->
        <div style="display:flex; gap:10px;">
            <button id="btnPenHome" onclick="selectPenaltyTeam('home')" style="flex:1; background:#ddd; color:#333;">Heim</button>
            <button id="btnPenGuest" onclick="selectPenaltyTeam('guest')" style="flex:1; background:#ddd; color:#333;">Gast</button>
        </div>

        <!-- Player List -->
        <div style="flex:1; overflow-y:auto; border:1px solid #eee; border-radius:4px; min-height:150px;">
            <div id="penaltyPlayerList" style="display:flex; flex-direction:column;">
                <!-- Filled via JS -->
                <div style="padding:10px; color:#888; text-align:center; font-style:italic;">Bitte erst Team w√§hlen...</div>
            </div>
        </div>

        <!-- Duration -->
        <div>
            <label>Dauer</label>
            <div style="display:flex; gap:5px; flex-wrap:wrap;">
                <button type="button" class="secondary" style="width:auto; flex:1;" onclick="setPenaltyDuration(120)">2 Min</button>
                <button type="button" class="secondary" style="width:auto; flex:1;" onclick="setPenaltyDuration(240)">2+2 Min</button>
                <button type="button" class="secondary" style="width:auto; flex:1;" onclick="setPenaltyDuration(300)">5 Min</button>
                <button type="button" class="secondary" style="width:auto; flex:1;" onclick="setPenaltyDuration(600)">10 Min</button>
            </div>
            <div style="margin-top:5px; display:flex; align-items:center; gap:5px;">
                 <input type="number" id="customPenMin" placeholder="Min" style="width:60px;">
                 <button type="button" class="secondary" style="width:auto;" onclick="setPenaltyDuration(document.getElementById('customPenMin').value * 60)">Custom</button>
            </div>
        </div>
        
        <input type="hidden" id="selectedPenaltyTeam">
        <input type="hidden" id="selectedPenaltyPlayerName">
        <input type="hidden" id="selectedPenaltyPlayerNumber">
        <input type="hidden" id="selectedPenaltyDuration">
        
        <div id="penaltySummary" style="padding:10px; background:#f8f9fa; border-radius:4px; font-weight:bold; text-align:center;">
            ...
        </div>

        <div style="display:flex; gap:10px;">
            <button class="secondary" onclick="closePenaltyModal()">Abbrechen</button>
            <button onclick="commitPenalty()" style="background:#28a745;">Hinzuf√ºgen</button>
        </div>
    </div>
</div>

<div id="aboutModal" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.5); z-index:2100; justify-content:center; align-items:center;">
    <div style="background:white; padding:25px; border-radius:8px; max-width:400px; max-height:80vh; overflow-y:auto; position:relative; box-shadow: 0 4px 15px rgba(0,0,0,0.2);">
        <span onclick="document.getElementById('aboutModal').style.display='none'" style="position:absolute; top:10px; right:15px; cursor:pointer; font-size:1.5em; color:#999;">&times;</span>
        
        <h3 style="margin-top:0;">√úber dieses Tool</h3>
        <p style="font-size:0.9em; line-height:1.5;">
            Dieser Scoreboard Generator ist ein Client-seitiges Tool. Es werden <strong>keine pers√∂nlichen Daten</strong> gesammelt oder an eigene Server gesendet.
        </p>
        
        <h4 style="margin-bottom:5px; font-size:1em;">Technologie</h4>
        <ul style="font-size:0.9em; padding-left:20px; margin-top:5px; color:#555;">
            <li>Einstellungen werden nur in Ihrem Browser gespeichert (<strong>LocalStorage</strong>).</li>
            <li>Spieldaten werden direkt von der <strong>API von saisonmanager.de</strong> geladen.</li>
            <li>Externe Ressourcen: Nur <strong>Google Fonts</strong> und <strong>Google APIs</strong> f√ºr Schriftarten.</li>
        </ul>

        <h4 style="margin-bottom:5px; font-size:1em;">Credits</h4>
        <ul style="font-size:0.9em; padding-left:20px; margin-top:5px; color:#555;">
            <li>QR Code Generator: <strong>qrcodejs</strong></li>
            <li>Icons & Fonts: <strong>Google Fonts</strong></li>
        </ul>
        
        <div style="margin-top:20px; font-size:0.8em; text-align:center; color:#888;">
            <a href="https://github.com/nonsensation/Spieltag" target="_blank" style="color:#007bff; text-decoration:none;">GitHub Repository</a>
        </div>
    </div>
</div>

<script>
    const BASE_URL = window.location.href.substring(0, window.location.href.lastIndexOf('/')) + '/boards.html';
    let gameDataFull = null;

    function openAboutModal() {
        document.getElementById('aboutModal').style.display = 'flex';
    }

    async function fetchGameDetails() {
        const id = document.getElementById('gameId').value;
        const loader = document.getElementById('loader');
        loader.style.display = 'block';
        loader.innerText = 'Laden...';

        try {
            const res = await fetch(`https://saisonmanager.de/api/v2/games/${id}.json`);
            if(!res.ok) throw new Error('Spiel nicht gefunden');
            const data = await res.json();
            gameDataFull = data;
            
            if(data.home_team_name) document.getElementById('hn').placeholder = `${data.home_team_name}`;
            if(data.guest_team_name) document.getElementById('gn').placeholder = `${data.guest_team_name}`;
            
            loader.innerText = `Gefunden: ${data.home_team_name} vs ${data.guest_team_name}`;
            loader.style.color = 'green';
            
            generate();

            const fixLogoUrl = (url) => {
                if (!url) return '';
                if (url.startsWith('/')) return 'https://saisonmanager.de' + url;
                return url;
            };

            if (data.home_team_logo) {
                const img = document.getElementById('homeLogoPreview');
                img.src = fixLogoUrl(data.home_team_logo);
                img.style.display = 'block';
            }
            if (data.guest_team_logo) {
                const img = document.getElementById('guestLogoPreview');
                img.src = fixLogoUrl(data.guest_team_logo);
                img.style.display = 'block';
            }

        } catch (e) {
            loader.innerText = e.message;
            loader.style.color = 'red';
        }
    }

    const DEFAULT_CODE = `<style>
    @import url('https://fonts.googleapis.com/css2?family=Quantico:wght@400;700;900&display=swap');
    
    .scoreboard {
        font-family: 'Quantico', sans-serif;
        font-weight: 900;
        font-size: min(2.5vw, 2.5vh); 
        width: fit-content;
        min-width: 40em;
        display: flex;
        flex-direction: column;
        background: transparent;
    }
    
    .header {
        background-color: #000;
        color: #fff;
        font-size: 0.75em;
        padding: 0;
        font-weight: 500;
        display: flex;
        justify-content: center;
        position: relative;
        min-height: 1.5em; 
    }
    
    .period {
        position: absolute; 
        left: 0;
        padding: 0.15em 0.5em;
    } 
    
    .time {
        display: none;
        padding: 0 0.5em;
        /* Default hidden, controlled by JS */
    }
    
    .teams {
        display: grid;
        grid-template-columns: 1fr 1fr;
        width: 100%;
    }
    
    .home, .away {
        display: flex;
        align-items: center;
        width: 100%;
        padding: 0;
        position: relative;
    }
    
    .home {
        background: linear-gradient(0deg, var(--home-secondary) 10%, var(--home-primary) 10%);
        color: var(--home-text);
    }
    
    .away {
        background: linear-gradient(0deg, var(--guest-secondary) 10%, var(--guest-primary) 10%);
        color: var(--guest-text);
    }
    
    .teamscore {
        display: flex;
        align-items: center;
        flex-grow: 1;
        justify-content: space-between;
        padding: 0 0.5em;
        overflow: hidden;
    }
    
    .name {
        flex-grow: 1;
        text-align: center;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
    }
    
    .score {
        font-weight: bold;
        padding: 0 0.5em;
    }
    
    img {
        height: 1.25em;
        padding: 0 0.2em;
        max-width: 3em; 
        object-fit: contain;
    }
</style>

<div class="scoreboard">
    <div class="header">
        <div class="period" id="period">1. Drittel</div>
        <div class="time">00:00</div>
    </div>
    <div class="teams">
        <!-- HOME -->
        <div class="home">
            <div class="logo">
                <img id="img_home" onerror="this.style.display='none'">
            </div>
            <div class="teamscore">
                <div class="name" id="name_home">HOME</div>
                <div class="score" id="score_home">0</div>
            </div>
        </div>
        
        <!-- AWAY -->
        <div class="away">
            <div class="teamscore">
                <div class="score" id="score_away">0</div>
                <div class="name" id="name_away">AWAY</div>
            </div>
            <div class="logo">
                <img id="img_away" onerror="this.style.display='none'">
            </div>
        </div>
    </div>
</div>`;

    function openEditor() {
        document.getElementById('editorModal').style.display = 'flex';
        // Ensure the editor has content
        if(!document.getElementById('customCode').value) {
            const stored = localStorage.getItem('scoreboardCustomCode');
            document.getElementById('customCode').value = stored || DEFAULT_CODE;
        }
    }

    function closeEditor() {
        document.getElementById('editorModal').style.display = 'none';
        generate(); // Final generate on close
    }

    function resetCustomCode() {
        document.getElementById('customCode').value = DEFAULT_CODE;
        generate();
    }

    let debounceTimer;
    function generate() {
        clearTimeout(debounceTimer);
        debounceTimer = setTimeout(() => {
            performGenerate();
        }, 500);
    }

    function performGenerate() {
        saveSettings();

        const params = new URLSearchParams();
        const id = document.getElementById('gameId').value;
        if(id) params.append('id', id);

        const design = document.getElementById('designStyle').value;
        if(design && design !== 'default') params.append('design', design);

        const customTrigger = document.getElementById('customCodeTrigger');
        if (design === 'custom') {
            customTrigger.style.display = 'block';
            const code = document.getElementById('customCode').value || DEFAULT_CODE;
            if(!document.getElementById('customCode').value) document.getElementById('customCode').value = code;
            localStorage.setItem('scoreboardCustomCode', code);
        } else {
            customTrigger.style.display = 'none';
        }

        const interval = document.getElementById('updateInterval').value;
        if(interval) params.append('interval', interval);

        const hn = document.getElementById('hn').value;
        const hp = document.getElementById('hp').value;
        const hs = document.getElementById('hs').value;
        const ht = document.getElementById('ht').value;
        
        if(hn) params.append('hn', hn);
        if(hp !== '#000000') params.append('hp', hp); 
        else params.append('hp', hp); 
        
        params.append('hs', hs);
        params.append('ht', ht);

        const gn = document.getElementById('gn').value;
        const gp = document.getElementById('gp').value;
        const gs = document.getElementById('gs').value;
        const gt = document.getElementById('gt').value;

        if(gn) params.append('gn', gn);
        params.append('gp', gp);
        params.append('gs', gs);
        params.append('gt', gt);

        const finalString = `${BASE_URL}?${params.toString()}`;
        
        // Update Iframe
        const iframe = document.getElementById('previewFrame');
        const newSrc = `boards.html?${params.toString()}`;
        
        if (design === 'custom') {
            // Force reload for custom design to pick up localStorage changes
            iframe.src = newSrc;
            // Force reload even if src string is identical because content (localStorage) changed
            // usage of newSrc directly might not trigger reload if identical
            // We append a timestamp or just reload contentWindow
            if(iframe.contentWindow && iframe.contentWindow.location.href.includes(newSrc)) {
                iframe.contentWindow.location.reload();
            } else {
                iframe.src = newSrc;
            }
        } else {
            if (!iframe.src.includes(params.toString())) {
                 iframe.src = newSrc;
            }
        }
        
        document.getElementById('urlOutput').style.display = 'block';
        document.getElementById('finalUrl').innerText = finalString;
        
        const btn = document.getElementById('copyBtn');
        if(btn.innerText === "Kopiert!") btn.innerText = "Kopieren & √ñffnen";

        // Update QR
        const qrContainer = document.getElementById('qrcode');
        qrContainer.innerHTML = "";
        new QRCode(qrContainer, {
            text: finalString,
            width: 128,
            height: 128,
            colorDark : "#000000",
            colorLight : "#ffffff",
            correctLevel : QRCode.CorrectLevel.L
        });
    }

    function copyAndOpen() {
        const urlText = document.getElementById('finalUrl').innerText;
        
        navigator.clipboard.writeText(urlText).then(() => {
            const btn = document.getElementById('copyBtn');
            const originalText = btn.innerText;
            btn.innerText = "Kopiert!";
            
            // Open in new tab
            window.open(urlText, '_blank');

            setTimeout(() => {
                btn.innerText = originalText;
            }, 3000);
        });
    }

    function saveSettings() {
        const settings = {
            gameId: document.getElementById('gameId').value,
            interval: document.getElementById('updateInterval').value,
            design: document.getElementById('designStyle').value,
            hn: document.getElementById('hn').value,
            hp: document.getElementById('hp').value,
            hs: document.getElementById('hs').value,
            ht: document.getElementById('ht').value,
            gn: document.getElementById('gn').value,
            gp: document.getElementById('gp').value,
            gs: document.getElementById('gs').value,
            gt: document.getElementById('gt').value
        };
        localStorage.setItem('scoreboardGenAttributes', JSON.stringify(settings));
    }

    function loadSettings() {
        const stored = localStorage.getItem('scoreboardGenAttributes');
        if (stored) {
            try {
                const s = JSON.parse(stored);
                if (s.gameId) document.getElementById('gameId').value = s.gameId;
                if (s.interval) document.getElementById('updateInterval').value = s.interval;
                if (s.design) document.getElementById('designStyle').value = s.design;
                if (s.hn) document.getElementById('hn').value = s.hn;
                if (s.hp) document.getElementById('hp').value = s.hp;
                if (s.hs) document.getElementById('hs').value = s.hs;
                if (s.ht) document.getElementById('ht').value = s.ht;
                if (s.gn) document.getElementById('gn').value = s.gn;
                if (s.gp) document.getElementById('gp').value = s.gp;
                if (s.gs) document.getElementById('gs').value = s.gs;
                if (s.gt) document.getElementById('gt').value = s.gt;
            } catch (e) { console.error(e); }
        }
        
        const customCode = localStorage.getItem('scoreboardCustomCode');
        if (customCode) {
            document.getElementById('customCode').value = customCode;
        } else {
            document.getElementById('customCode').value = DEFAULT_CODE;
        }
    }

    window.onload = function() {
        loadSettings();
        fetchGameDetails();
    };
    // --- TIMER LOGIC ---
    let timerState = {
        running: false,
        seconds: 1200, // Default 20 min
        target: 1200,  // Target (start or end)
        direction: -1, // -1 down, 1 up
        visible: false,
        lastTick: 0
    };
    
    let penalties = []; // { id, team, player, number, remaining, max }

    
    let timerInterval = null;
    const timerChannel = new BroadcastChannel('scoreboard_timer');

    function formatTime(totalSeconds) {
        const sign = totalSeconds < 0 ? "-" : "";
        const s = Math.abs(totalSeconds);
        const m = Math.floor(s / 60);
        const sec = s % 60;
        return `${sign}${m.toString().padStart(2, '0')}:${sec.toString().padStart(2, '0')}`;
    }

    function updateTimerDisplay() {
        const el = document.getElementById('timerValue');
        el.innerText = formatTime(timerState.seconds);
        
        // Toggle Play/Stop Btn
        const btnStart = document.getElementById('btnStart');
        const btnStop = document.getElementById('btnStop');
        
        if(timerState.running) {
            btnStart.classList.add('hidden');
            btnStop.classList.remove('hidden');
        } else {
            btnStart.classList.remove('hidden');
            btnStop.classList.add('hidden');
        }

        // Check Mode
        const mode = document.getElementById('penaltyMode').value;

        // Render Penalties in Controller
        if (mode === 'none') {
             const cHome = document.getElementById('ctlPenaltiesHome');
             const cGuest = document.getElementById('ctlPenaltiesGuest');
             if(cHome) cHome.innerHTML = '';
             if(cGuest) cGuest.innerHTML = '';
        } else {
             renderControllerPenalties();
        }

        // Broadcast
        timerChannel.postMessage({
            type: 'timer_update',
            timeString: formatTime(timerState.seconds),
            visible: timerState.visible,
            running: timerState.running,
            penalties: (mode === 'none') ? [] : penalties
        });
    }

    function togglePenaltyMode() {
        const mode = document.getElementById('penaltyMode').value;
        const btn = document.getElementById('btnAddPenalty');
        if (btn) {
            // btn-reset has modest styling, let's just toggle visibility
            btn.style.display = (mode === 'none') ? 'none' : 'inline-block';
        }
        updateTimerDisplay();
    }


    // --- PENALTY LOGIC ---

    function openPenaltyModal() {
        document.getElementById('penaltyModal').style.display = 'flex';
        // Reset state
        document.getElementById('selectedPenaltyTeam').value = '';
        document.getElementById('selectedPenaltyPlayerName').value = '';
        document.getElementById('selectedPenaltyPlayerNumber').value = '';
        document.getElementById('selectedPenaltyDuration').value = '';
        
        document.getElementById('btnPenHome').style.background = '#ddd';
        document.getElementById('btnPenHome').style.color = '#333';
        document.getElementById('btnPenGuest').style.background = '#ddd';
        document.getElementById('btnPenGuest').style.color = '#333';
        
        document.getElementById('penaltyPlayerList').innerHTML = '<div style="padding:10px; color:#888; text-align:center;">Bitte Team w√§hlen</div>';
        updatePenaltySummary();
    }

    function closePenaltyModal() {
        document.getElementById('penaltyModal').style.display = 'none';
    }

    function selectPenaltyTeam(team) {
        document.getElementById('selectedPenaltyTeam').value = team;
        
        // Style buttons
        const btnHome = document.getElementById('btnPenHome');
        const btnGuest = document.getElementById('btnPenGuest');
        
        // Fetch colors from inputs
        const homeColor = document.getElementById('hp').value;
        const guestColor = document.getElementById('gp').value;

        if (team === 'home') {
            btnHome.style.background = homeColor;
            btnHome.style.color = 'white'; // simplistic contrast
            btnGuest.style.background = '#ddd';
            btnGuest.style.color = '#333';
            renderPlayerList(team, gameDataFull?.players?.home);
        } else {
            btnGuest.style.background = guestColor;
            btnGuest.style.color = 'white';
            btnHome.style.background = '#ddd';
            btnHome.style.color = '#333';
            renderPlayerList(team, gameDataFull?.players?.guest);
        }
        updatePenaltySummary();
    }

    function renderPlayerList(team, players) {
        const container = document.getElementById('penaltyPlayerList');
        container.innerHTML = '';
        
        if (!players || players.length === 0) {
            container.innerHTML = '<div style="padding:10px; text-align:center;">Keine Spielerdaten verf√ºgbar.</div>';
            return;
        }

        players.forEach(p => {
            const row = document.createElement('div');
            row.style.padding = '8px';
            row.style.borderBottom = '1px solid #eee';
            row.style.cursor = 'pointer';
            row.style.display = 'flex';
            row.style.gap = '10px';
            
            // Map JSON properties
            const num = p.trikot_number;
            const fname = p.player_firstname;
            const lname = p.player_name;

            row.onclick = () => {
                // Highlight
                Array.from(container.children).forEach(c => c.style.background = 'transparent');
                row.style.background = '#eef';
                
                document.getElementById('selectedPenaltyPlayerName').value = lname || fname; 
                document.getElementById('selectedPenaltyPlayerNumber').value = num || '';
                updatePenaltySummary();
            };
            
            row.innerHTML = `
                <span style="font-weight:bold; width:30px;">${num || '-'}</span>
                <span>${fname} ${lname}</span>
            `;
            container.appendChild(row);
        });
    }

    function setPenaltyDuration(sec) {
        document.getElementById('selectedPenaltyDuration').value = sec;
        updatePenaltySummary();
    }

    function updatePenaltySummary() {
        const team = document.getElementById('selectedPenaltyTeam').value;
        const name = document.getElementById('selectedPenaltyPlayerName').value;
        const number = document.getElementById('selectedPenaltyPlayerNumber').value;
        const dur = document.getElementById('selectedPenaltyDuration').value;
        
        let text = [];
        if(team) text.push(team === 'home' ? 'HEIM' : 'GAST');
        if(number) text.push(`#${number}`);
        if(name) text.push(name);
        if(dur) text.push(formatTime(dur));
        
        document.getElementById('penaltySummary').innerText = text.length ? text.join(' | ') : '...';
    }

    function commitPenalty() {
        const team = document.getElementById('selectedPenaltyTeam').value;
        const name = document.getElementById('selectedPenaltyPlayerName').value;
        const number = document.getElementById('selectedPenaltyPlayerNumber').value;
        const dur = parseInt(document.getElementById('selectedPenaltyDuration').value);
        
        if (!team || !dur) {
            alert('Bitte Team und Dauer w√§hlen!');
            return;
        }
        
        penalties.push({
            id: Date.now() + Math.random(),
            team: team,
            player: name || 'Spieler',
            number: number || '00',
            remaining: dur,
            max: dur
        });
        
        closePenaltyModal();
        updateTimerDisplay();
    }

    function removePenalty(id) {
        penalties = penalties.filter(p => p.id !== id);
        updateTimerDisplay();
    }

    function renderControllerPenalties() {
        const cHome = document.getElementById('ctlPenaltiesHome');
        const cGuest = document.getElementById('ctlPenaltiesGuest');
        cHome.innerHTML = '';
        cGuest.innerHTML = '';

        penalties.forEach(p => {
            const el = document.createElement('div');
            el.className = 'penalty-tag';
            // Styling for controller tags
            el.style.background = 'rgba(0,0,0,0.7)';
            el.style.color = '#fff';
            el.style.padding = '4px 8px';
            el.style.borderRadius = '4px';
            el.style.fontSize = '0.8em';
            el.style.display = 'flex';
            el.style.alignItems = 'center';
            el.style.gap = '8px';
            
            el.innerHTML = `
                <span style="font-weight:bold; color:#ffcc00;">${formatTime(p.remaining)}</span>
                <span>#${p.number}</span>
                <span style="font-size:0.8em; opacity:0.7;">${p.player.substring(0,8)}</span>
                <span onclick="removePenalty(${p.id})" style="cursor:pointer; color:#ff5555; margin-left:5px; font-weight:bold;">&times;</span>
            `;
            
            if(p.team === 'home') cHome.appendChild(el);
            else cGuest.appendChild(el);
        });
    }
    
    function toggleTimerVis() {
        timerState.visible = !timerState.visible;
        const btn = document.getElementById('visToggle');
        if(timerState.visible) {
            btn.classList.add('active');
            // btn.querySelector('span:nth-child(2)').innerText = "Verbergen";
        } else {
            btn.classList.remove('active');
            // btn.querySelector('span:nth-child(2)').innerText = "Anzeigen";
        }
        updateTimerDisplay();
    }

    function startTimer() {
        if(timerState.running) return;
        timerState.running = true;
        timerState.lastTick = Date.now();
        
        timerInterval = setInterval(() => {
            const now = Date.now();
            const delta = now - timerState.lastTick;
            
            // Should be approx 1000ms
            if(delta >= 1000) {
                // Determine step
                const steps = Math.floor(delta / 1000);
                timerState.seconds += (steps * timerState.direction);
                timerState.lastTick += (steps * 1000);
                
                // Tick Penalties (only if timer is counting down? User said "when the timer runs")
                // Usually penalties only count down when game time runs.
                if (timerState.running) { 
                    penalties.forEach(p => {
                        if (p.remaining > 0) p.remaining -= steps;
                        if (p.remaining < 0) p.remaining = 0;
                    });
                     // Remove expired? Usually we keep them until stoppage or user clears, 
                     // but standard is they disappear when done or stay until faceoff.
                     // User said: "remove them" via x-icon, implying manual removal might be needed,
                     // but "time should also be count down".
                     // Let's AUTO-REMOVE if 0 for now to keep it clean, or maybe keep at 0:00?
                     // Standard scoreboard behavior: they disappear when 0.
                     penalties = penalties.filter(p => p.remaining > 0);
                }

                
                // Check stops
                if (timerState.direction === -1 && timerState.seconds <= 0) {
                    timerState.seconds = 0;
                    stopTimer();
                } else if (timerState.direction === 1 && timerState.seconds >= timerState.target && timerState.target > 0) {
                    // Only stop going up if we have a target (non-zero usually, but here target is the 'length')
                    // Logic check: "toggle: count up/down".
                    // If up, usually starts at 0. 'Target' might be the max time.
                    // For now, let's just let it run unless we explicitly define a stop.
                    // The user said "target time when it automatically stops".
                    if(timerState.seconds >= timerState.target) {
                        timerState.seconds = timerState.target;
                        stopTimer();
                    }
                }
                
                updateTimerDisplay();
            }
        }, 100); // Check more often for precision
        updateTimerDisplay();
    }

    function stopTimer() {
        timerState.running = false;
        clearInterval(timerInterval);
        updateTimerDisplay();
    }

    function resetTimer() {
        stopTimer();
        applyPreset();
    }

    function adjustTime(sec) {
        timerState.seconds += sec;
        if(timerState.seconds < 0) timerState.seconds = 0;
        updateTimerDisplay();
    }
    
    function updateDirection() {
        const r = document.querySelector('input[name="tm_dir"]:checked');
        timerState.direction = parseInt(r.value);
        // If we switch direction, do we reset?
        // Usually safer to apply preset again to ensure start/end points are correct
        applyPreset();
    }

    function applyPreset() {
        const val = document.getElementById('timerPreset').value;
        // Check if radio exists, otherwise default -1
        const r = document.querySelector('input[name="tm_dir"]:checked');
        let dir = -1;
        if(r) dir = parseInt(r.value);
        
        let mins = 20;

        if (val === 'custom') {
            document.getElementById('customTimeInput').style.display = 'flex';
            mins = parseInt(document.getElementById('customMin').value) || 0;
        } else {
            const cti = document.getElementById('customTimeInput');
            if(cti) cti.style.display = 'none';
            mins = parseInt(val);
        }

        const totalSec = mins * 60;
        timerState.target = totalSec;
        timerState.direction = dir;

        // Logic:
        // If DOWN: start = target (e.g. 20:00), end = 0.
        // If UP: start = 0, end = target (e.g. 20:00).
        
        if (timerState.direction === -1) {
            timerState.seconds = totalSec;
        } else {
            timerState.seconds = 0;
        }
        
        // If running, we might want to stop? Or allow hot swapping?
        // Let's keep it simple: resetting time doesn't stop it if you just clicked, 
        // BUT changing preset usually implies a reset.
        stopTimer(); // Ensure we stop when changing preset completely
        
        updateTimerDisplay();
    }

    // Initialize Broadcast on load to ensure state is clean
    window.addEventListener('load', () => {
        applyPreset(); // Set default 20:00
    });

</script>

</body>
</html>