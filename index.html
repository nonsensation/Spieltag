<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Scoreboard Generator</title>
    <!-- Add QR Code JS -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    <style>
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; padding: 20px; background: #f0f2f5; color: #333; margin: 0; height: 100vh; display: flex; flex-direction: column; overflow: hidden; }
        
        .container { 
            display: flex; 
            flex: 1; 
            width: 100%; 
            height: 100%; 
            max-width: 100%; 
            gap: 20px; 
            padding-bottom: 20px;
            box-sizing: border-box;
        }

        /* Preview Area: Takes up available space */
        .preview { 
            flex: 1; 
            background-color: #202020;
            background-image:
              linear-gradient(45deg, #2a2a2a 25%, transparent 25%),
              linear-gradient(-45deg, #2a2a2a 25%, transparent 25%),
              linear-gradient(45deg, transparent 75%, #2a2a2a 75%),
              linear-gradient(-45deg, transparent 75%, #2a2a2a 75%);
            background-size: 20px 20px;
            background-position: 0 0, 0 10px, 10px -10px, -10px 0px;
            box-shadow: inset 0 0 20px rgba(0,0,0,0.5);
            border-radius: 8px; 
            display: flex; 
            justify-content: center; 
            align-items: center; 
            flex-direction: column;
            position: relative;
            overflow: hidden;
            border: 1px solid #444;
        }

        .preview h2 {
            position: absolute;
            top: 10px;
            left: 20px;
            color: rgba(255,255,255,0.5);
            margin: 0;
            font-size: 1.2rem;
            z-index: 10;
        }

        /* Controls Sidebar: Fixed width or limited flex */
        .controls { 
            width: 320px; 
            min-width: 320px;
            background: white; 
            padding: 20px; 
            border-radius: 8px; 
            box-shadow: -2px 0 10px rgba(0,0,0,0.1); 
            overflow-y: auto;
            display: flex;
            flex-direction: column;
        }

        h3 { margin-top: 0; border-bottom: 2px solid #eee; padding-bottom: 10px; margin-bottom: 15px; }
        
        .form-group { margin-bottom: 12px; }
        label { display: block; margin-bottom: 4px; font-weight: 600; font-size: 0.85em; color: #555; }
        input[type="text"], input[type="number"], select { width: 100%; padding: 8px; border: 1px solid #ccc; border-radius: 4px; box-sizing: border-box; font-size: 0.9em; }
        
        .color-row { display: flex; gap: 8px; align-items: center; }
        input[type="color"] { border: none; width: 100%; height: 35px; cursor: pointer; background: none; padding: 0; }
        
        .section-title { font-size: 0.8em; text-transform: uppercase; letter-spacing: 1px; color: #888; margin-top: 15px; margin-bottom: 8px; font-weight: bold; border-bottom: 1px solid #eee; padding-bottom: 2px;}

        button { background: #007bff; color: white; border: none; padding: 10px; border-radius: 4px; cursor: pointer; font-size: 0.95em; width: 100%; margin-top: 5px; transition: background 0.2s; font-weight: 500;}
        button:hover { background: #0056b3; }
        button.secondary { background: #6c757d; }
        button.secondary:hover { background: #5a6268; }
        
        iframe { border: none; width: 100%; height: 100%; background: transparent; }
        
        .loader { font-size: 0.8em; color: #666; font-style: italic; display: none; margin-top: 5px;}
        
        .url-output { margin-top: auto; padding-top: 20px; border-top: 2px solid #eee; }
        .url-text { font-family: monospace; font-size: 0.8em; word-break: break-all; color: #555; background: #f8f9fa; padding: 5px; border-radius: 4px; border: 1px solid #ddd; margin-bottom: 10px; max-height: 60px; overflow-y: auto; }

        #qrcode {
            margin-top: 15px;
            display: flex;
            justify-content: center;
            background: white;
            padding: 10px;
            border-radius: 4px;
            border: 1px solid #eee;
            width: fit-content;
            margin-left: auto; 
            margin-right: auto; 
        }
        #qrcode img {
            display: block;
        }

        @media (max-width: 900px) {
            .container { flex-direction: column-reverse; height: auto; overflow: visible; }
            body { height: auto; overflow: auto; }
            .controls { width: 100%; min-width: 0; }
            .preview { min-height: 400px; }
        }
    </style>
</head>
<body>

<div class="container">
    <!-- PREVIEW AREA -->
    <div class="preview">
        <h2>Live Vorschau</h2>
        <iframe id="previewFrame" src="boards.html?id=42941"></iframe>
    </div>

    <!-- SIDEBAR CONTROLS -->
    <div class="controls">
        <h3>Konfiguration</h3>
        
        <div class="form-group">
            <label>Design Stil</label>
            <select id="designStyle" onchange="generate()">
                <option value="default">Standard (Original)</option>
                <option value="retro">Retro Pixel</option>
                <option value="modern">Modern Schlicht</option>
                <option value="neon">Neon</option>
                <option value="broadcast">TV Übertragung</option>
                <option value="glass">Glassmorphism</option>
                <option value="bold">Fett Gedruckt</option>
                <option value="material">Material Karte</option>
                <option value="cyberpunk">Cyberpunk</option>
                <option value="islands">Schwebende Inseln</option>
                <option value="custom">Eigener Code</option>
            </select>
        </div>

        <div id="customCodeTrigger" style="display:none; margin-bottom: 20px;">
             <button type="button" onclick="openEditor()" style="background:#28a745; width:100%;">Code Editor öffnen</button>
             <div style="font-size:0.8em; color:#666; margin-top:5px; font-style:italic;">Klicken zum Bearbeiten des eigenen Designs.</div>
        </div>

        <!-- Full Screen Editor Modal -->
        <div id="editorModal" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:white; z-index:2000; flex-direction:column;">
            <!-- Modal Header -->
            <div style="display:flex; justify-content:space-between; align-items:center; padding:10px 20px; background:#f8f9fa; border-bottom:1px solid #ddd;">
                <h3 style="margin:0; border:none; padding:0;">Editor für eigenes Design</h3>
                <div style="display:flex; gap:10px;">
                    <button type="button" class="secondary" onclick="resetCustomCode()" style="width:auto; padding:8px 15px; margin:0; background:#dc3545;">Zurücksetzen</button>
                    <button type="button" onclick="closeEditor()" style="width:auto; padding:8px 15px; margin:0;">Speichern & Schließen</button>
                </div>
            </div>
            
            <!-- Modal Body -->
            <div style="display:flex; flex:1; overflow:hidden;">
                <!-- Code Area -->
                <div style="flex:1; display:flex; flex-direction:column; padding:10px; border-right:1px solid #ddd;">
                    <label style="margin-bottom:5px;">HTML & CSS</label>
                    <textarea id="customCode" style="flex:1; width:100%; border:1px solid #ccc; font-family:monospace; font-size:14px; padding:10px; white-space:pre; resize:none; box-sizing:border-box;" placeholder="Füge hier deinen HTML Scoreboard Code ein..." oninput="generate(true)"></textarea>
                </div>
                
                <!-- Info Sidebar -->
                <div style="width:300px; padding:15px; overflow-y:auto; background:#fafafa;">
                    <h4 style="margin-top:0;">Verfügbare Variablen</h4>
                    <p style="font-size:0.9em; color:#666;">Benutze diese IDs für die Datenbindung:</p>
                    <ul style="font-size:0.85em; padding-left:20px; color:#444;">
                        <li><code>period</code>: Aktueller Abschnitt</li>
                        <li><code>time</code>: Spielzeit (meist unsichtbar)</li>
                        <li><code>img_home</code>: Heim Logo (img src)</li>
                        <li><code>name_home</code>: Heim Name</li>
                        <li><code>score_home</code>: Heim Tore</li>
                        <li><code>img_away</code>: Gast Logo (img src)</li>
                        <li><code>name_away</code>: Gast Name</li>
                        <li><code>score_away</code>: Gast Tore</li>
                    </ul>

                    <h4 style="margin-top:15px;">CSS Variablen</h4>
                    <p style="font-size:0.9em; color:#666;">Benutze <code>var(--name)</code> für Farben:</p>
                    <ul style="font-size:0.85em; padding-left:20px; color:#444;">
                        <li><code>--home-primary</code></li>
                        <li><code>--home-secondary</code></li>
                        <li><code>--home-text</code></li>
                        <li><code>--guest-primary</code></li>
                        <li><code>--guest-secondary</code></li>
                        <li><code>--guest-text</code></li>
                    </ul>
                    
                    <div style="margin-top:20px; padding:10px; background:#e9ecef; border-radius:4px; font-size:0.85em;">
                        <strong>Tipp:</strong> Nutze einen Container mit der Klasse <code>scoreboard</code>.
                    </div>
                </div>
            </div>
        </div>
        
        <div class="form-group">
            <label>Spiel ID</label>
            <div style="display:flex; gap:5px;">
                <input type="number" id="gameId" value="42941" placeholder="z.B. 42941" oninput="fetchGameDetails()">
                <button type="button" onclick="fetchGameDetails()" style="width: auto; margin:0; padding: 0 15px;">Laden</button>
            </div>
            <div class="loader" id="loader">Lade Namen...</div>
        </div>

        <div class="section-title">Heimteam</div>
        <div class="form-group">
            <div style="display:flex; align-items: center; gap: 10px; margin-bottom: 5px;">
                <img id="homeLogoPreview" src="" alt="" style="display:none; height: 30px; object-fit: contain;">
                <input type="text" id="hn" placeholder="Name überschreiben" oninput="generate()">
            </div>
            <div class="color-row">
                <input type="color" id="hp" value="#000000" title="Primär" oninput="generate()">
                <input type="color" id="hs" value="#1e713a" title="Sekundär" oninput="generate()">
                <input type="color" id="ht" value="#ffffff" title="Text" oninput="generate()">
            </div>
        </div>

        <div class="section-title">Gastteam</div>
        <div class="form-group">
            <div style="display:flex; align-items: center; gap: 10px; margin-bottom: 5px;">
                <img id="guestLogoPreview" src="" alt="" style="display:none; height: 30px; object-fit: contain;">
                <input type="text" id="gn" placeholder="Name überschreiben" oninput="generate()">
            </div>
            <div class="color-row">
                <input type="color" id="gp" value="#ff0000" title="Primär" oninput="generate()">
                <input type="color" id="gs" value="#ffffff" title="Sekundär" oninput="generate()">
                <input type="color" id="gt" value="#000000" title="Text" oninput="generate()">
            </div>
        </div>

        <div class="url-output" id="urlOutput" style="display:none;">
            <label>Generierte URL:</label>
            <div class="url-text" id="finalUrl"></div>
            <button id="copyBtn" onclick="copyAndOpen()">Kopieren & Öffnen</button>
            
            <div id="qrcode"></div>
        </div>
        
        <footer style="margin-top: 30px; padding-top: 15px; border-top: 1px solid #eee; text-align: center;">
            <a href="#" onclick="openAboutModal()" style="color: #666; text-decoration: none; font-size: 0.85em;">Über & Datenschutz</a>
        </footer>
    </div>
</div>

<!-- About Modal -->
<div id="aboutModal" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.5); z-index:2000; justify-content:center; align-items:center;">
    <div style="background:white; padding:25px; border-radius:8px; max-width:400px; max-height:80vh; overflow-y:auto; position:relative; box-shadow: 0 4px 15px rgba(0,0,0,0.2);">
        <span onclick="document.getElementById('aboutModal').style.display='none'" style="position:absolute; top:10px; right:15px; cursor:pointer; font-size:1.5em; color:#999;">&times;</span>
        
        <h3 style="margin-top:0;">Über dieses Tool</h3>
        <p style="font-size:0.9em; line-height:1.5;">
            Dieser Scoreboard Generator ist ein Client-seitiges Tool. Es werden <strong>keine persönlichen Daten</strong> gesammelt oder an eigene Server gesendet.
        </p>
        
        <h4 style="margin-bottom:5px; font-size:1em;">Technologie</h4>
        <ul style="font-size:0.9em; padding-left:20px; margin-top:5px; color:#555;">
            <li>Einstellungen werden nur in Ihrem Browser gespeichert (<strong>LocalStorage</strong>).</li>
            <li>Spieldaten werden direkt von der <strong>API von saisonmanager.de</strong> geladen.</li>
            <li>Externe Ressourcen: Nur <strong>Google Fonts</strong> und <strong>Google APIs</strong> für Schriftarten.</li>
        </ul>

        <h4 style="margin-bottom:5px; font-size:1em;">Credits</h4>
        <ul style="font-size:0.9em; padding-left:20px; margin-top:5px; color:#555;">
            <li>QR Code Generator: <strong>qrcodejs</strong></li>
            <li>Icons & Fonts: <strong>Google Fonts</strong></li>
        </ul>
        
        <div style="margin-top:20px; font-size:0.8em; text-align:center; color:#888;">
            <a href="https://github.com/nonsensation/Spieltag" target="_blank" style="color:#007bff; text-decoration:none;">GitHub Repository</a>
        </div>
    </div>
</div>

<script>
    const BASE_URL = window.location.href.substring(0, window.location.href.lastIndexOf('/')) + '/boards.html';

    function openAboutModal() {
        document.getElementById('aboutModal').style.display = 'flex';
    }

    async function fetchGameDetails() {
        const id = document.getElementById('gameId').value;
        const loader = document.getElementById('loader');
        loader.style.display = 'block';
        loader.innerText = 'Laden...';

        try {
            const res = await fetch(`https://saisonmanager.de/api/v2/games/${id}.json`);
            if(!res.ok) throw new Error('Spiel nicht gefunden');
            const data = await res.json();
            
            if(data.home_team_name) document.getElementById('hn').placeholder = `${data.home_team_name}`;
            if(data.guest_team_name) document.getElementById('gn').placeholder = `${data.guest_team_name}`;
            
            loader.innerText = `Gefunden: ${data.home_team_name} vs ${data.guest_team_name}`;
            loader.style.color = 'green';
            
            generate();

            const fixLogoUrl = (url) => {
                if (!url) return '';
                if (url.startsWith('/')) return 'https://saisonmanager.de' + url;
                return url;
            };

            if (data.home_team_logo) {
                const img = document.getElementById('homeLogoPreview');
                img.src = fixLogoUrl(data.home_team_logo);
                img.style.display = 'block';
            }
            if (data.guest_team_logo) {
                const img = document.getElementById('guestLogoPreview');
                img.src = fixLogoUrl(data.guest_team_logo);
                img.style.display = 'block';
            }

        } catch (e) {
            loader.innerText = e.message;
            loader.style.color = 'red';
        }
    }

    const DEFAULT_CODE = `<style>
    @import url('https://fonts.googleapis.com/css2?family=Quantico:wght@400;700;900&display=swap');
    
    .scoreboard {
        font-family: 'Quantico', sans-serif;
        font-weight: 900;
        font-size: min(2.5vw, 2.5vh); 
        width: fit-content;
        min-width: 40em;
        display: flex;
        flex-direction: column;
        background: transparent;
    }
    
    .header {
        background-color: #000;
        color: #fff;
        font-size: 0.75em;
        padding: 0;
        font-weight: 500;
        display: flex;
        justify-content: center;
        position: relative;
        min-height: 1.5em; 
    }
    
    .period {
        position: absolute; 
        left: 0;
        padding: 0.15em 0.5em;
    } 
    
    .teams {
        display: grid;
        grid-template-columns: 1fr 1fr;
        width: 100%;
    }
    
    .home, .away {
        display: flex;
        align-items: center;
        width: 100%;
        padding: 0;
        position: relative;
    }
    
    .home {
        background: linear-gradient(0deg, var(--home-secondary) 10%, var(--home-primary) 10%);
        color: var(--home-text);
    }
    
    .away {
        background: linear-gradient(0deg, var(--guest-secondary) 10%, var(--guest-primary) 10%);
        color: var(--guest-text);
    }
    
    .teamscore {
        display: flex;
        align-items: center;
        flex-grow: 1;
        justify-content: space-between;
        padding: 0 0.5em;
        overflow: hidden;
    }
    
    .name {
        flex-grow: 1;
        text-align: center;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
    }
    
    .score {
        font-weight: bold;
        padding: 0 0.5em;
    }
    
    img {
        height: 1.25em;
        padding: 0 0.2em;
        max-width: 3em; 
        object-fit: contain;
    }
</style>

<div class="scoreboard">
    <div class="header">
        <div class="period" id="period">1. Drittel</div>
    </div>
    <div class="teams">
        <!-- HOME -->
        <div class="home">
            <div class="logo">
                <img id="img_home" onerror="this.style.display='none'">
            </div>
            <div class="teamscore">
                <div class="name" id="name_home">HOME</div>
                <div class="score" id="score_home">0</div>
            </div>
        </div>
        
        <!-- AWAY -->
        <div class="away">
            <div class="teamscore">
                <div class="score" id="score_away">0</div>
                <div class="name" id="name_away">AWAY</div>
            </div>
            <div class="logo">
                <img id="img_away" onerror="this.style.display='none'">
            </div>
        </div>
    </div>
</div>`;

    function openEditor() {
        document.getElementById('editorModal').style.display = 'flex';
        // Ensure the editor has content
        if(!document.getElementById('customCode').value) {
            const stored = localStorage.getItem('scoreboardCustomCode');
            document.getElementById('customCode').value = stored || DEFAULT_CODE;
        }
    }

    function closeEditor() {
        document.getElementById('editorModal').style.display = 'none';
        generate(); // Final generate on close
    }

    function resetCustomCode() {
        document.getElementById('customCode').value = DEFAULT_CODE;
        generate();
    }

    let debounceTimer;
    function generate() {
        clearTimeout(debounceTimer);
        debounceTimer = setTimeout(() => {
            performGenerate();
        }, 500);
    }

    function performGenerate() {
        saveSettings();

        const params = new URLSearchParams();
        const id = document.getElementById('gameId').value;
        if(id) params.append('id', id);

        const design = document.getElementById('designStyle').value;
        if(design && design !== 'default') params.append('design', design);

        const customTrigger = document.getElementById('customCodeTrigger');
        if (design === 'custom') {
            customTrigger.style.display = 'block';
            const code = document.getElementById('customCode').value || DEFAULT_CODE;
            if(!document.getElementById('customCode').value) document.getElementById('customCode').value = code;
            localStorage.setItem('scoreboardCustomCode', code);
        } else {
            customTrigger.style.display = 'none';
        }

        const hn = document.getElementById('hn').value;
        const hp = document.getElementById('hp').value;
        const hs = document.getElementById('hs').value;
        const ht = document.getElementById('ht').value;
        
        if(hn) params.append('hn', hn);
        if(hp !== '#000000') params.append('hp', hp); 
        else params.append('hp', hp); 
        
        params.append('hs', hs);
        params.append('ht', ht);

        const gn = document.getElementById('gn').value;
        const gp = document.getElementById('gp').value;
        const gs = document.getElementById('gs').value;
        const gt = document.getElementById('gt').value;

        if(gn) params.append('gn', gn);
        params.append('gp', gp);
        params.append('gs', gs);
        params.append('gt', gt);

        const finalString = `${BASE_URL}?${params.toString()}`;
        
        // Update Iframe
        const iframe = document.getElementById('previewFrame');
        const newSrc = `boards.html?${params.toString()}`;
        
        if (design === 'custom') {
            // Force reload for custom design to pick up localStorage changes
            iframe.src = newSrc;
            // Force reload even if src string is identical because content (localStorage) changed
            // usage of newSrc directly might not trigger reload if identical
            // We append a timestamp or just reload contentWindow
            if(iframe.contentWindow && iframe.contentWindow.location.href.includes(newSrc)) {
                iframe.contentWindow.location.reload();
            } else {
                iframe.src = newSrc;
            }
        } else {
            if (!iframe.src.includes(params.toString())) {
                 iframe.src = newSrc;
            }
        }
        
        document.getElementById('urlOutput').style.display = 'block';
        document.getElementById('finalUrl').innerText = finalString;
        
        const btn = document.getElementById('copyBtn');
        if(btn.innerText === "Kopiert!") btn.innerText = "Kopieren & Öffnen";

        // Update QR
        const qrContainer = document.getElementById('qrcode');
        qrContainer.innerHTML = "";
        new QRCode(qrContainer, {
            text: finalString,
            width: 128,
            height: 128,
            colorDark : "#000000",
            colorLight : "#ffffff",
            correctLevel : QRCode.CorrectLevel.L
        });
    }

    function copyAndOpen() {
        const urlText = document.getElementById('finalUrl').innerText;
        
        navigator.clipboard.writeText(urlText).then(() => {
            const btn = document.getElementById('copyBtn');
            const originalText = btn.innerText;
            btn.innerText = "Kopiert!";
            
            // Open in new tab
            window.open(urlText, '_blank');

            setTimeout(() => {
                btn.innerText = originalText;
            }, 3000);
        });
    }

    function saveSettings() {
        const settings = {
            gameId: document.getElementById('gameId').value,
            design: document.getElementById('designStyle').value,
            hn: document.getElementById('hn').value,
            hp: document.getElementById('hp').value,
            hs: document.getElementById('hs').value,
            ht: document.getElementById('ht').value,
            gn: document.getElementById('gn').value,
            gp: document.getElementById('gp').value,
            gs: document.getElementById('gs').value,
            gt: document.getElementById('gt').value
        };
        localStorage.setItem('scoreboardGenAttributes', JSON.stringify(settings));
    }

    function loadSettings() {
        const stored = localStorage.getItem('scoreboardGenAttributes');
        if (stored) {
            try {
                const s = JSON.parse(stored);
                if (s.gameId) document.getElementById('gameId').value = s.gameId;
                if (s.design) document.getElementById('designStyle').value = s.design;
                if (s.hn) document.getElementById('hn').value = s.hn;
                if (s.hp) document.getElementById('hp').value = s.hp;
                if (s.hs) document.getElementById('hs').value = s.hs;
                if (s.ht) document.getElementById('ht').value = s.ht;
                if (s.gn) document.getElementById('gn').value = s.gn;
                if (s.gp) document.getElementById('gp').value = s.gp;
                if (s.gs) document.getElementById('gs').value = s.gs;
                if (s.gt) document.getElementById('gt').value = s.gt;
            } catch (e) { console.error(e); }
        }
        
        const customCode = localStorage.getItem('scoreboardCustomCode');
        if (customCode) {
            document.getElementById('customCode').value = customCode;
        } else {
            document.getElementById('customCode').value = DEFAULT_CODE;
        }
    }

    window.onload = function() {
        loadSettings();
        fetchGameDetails();
    };
</script>

</body>
</html>